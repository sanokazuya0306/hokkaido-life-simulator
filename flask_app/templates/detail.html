{% extends "base.html" %}

{% block content %}
{% set rank = score_result.get('rank', 'B') %}
{% set total_score = score_result.get('total_score', 0)|int %}
{% set rank_label = score_result.get('rank_label', '') %}
{% set parent_rank = parent_result.get('rank', 'B') %}

<div class="detail-container">
    <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
    <a href="{{ url_for('result') }}" class="close-btn">Ã—</a>
    
    <!-- è©³ç´°ã‚«ãƒ¼ãƒ‰ -->
    <div class="detail-card">
        <!-- äººç”Ÿã‚¹ãƒˆãƒ¼ãƒªãƒ¼ -->
        <div class="life-story">{{ life_story }}</div>
        
        <!-- äººç”Ÿãƒ©ãƒ³ã‚¯è¡¨ç¤º -->
        {% if rank == 'SS' %}
            {% set display_class = 'rank-display-ss' %}
            {% set rank_color = '#D8D8D8' %}
        {% elif rank == 'S' %}
            {% set display_class = 'rank-display-s' %}
            {% set rank_color = '#000000' %}
        {% else %}
            {% set display_class = 'rank-display-other' %}
            {% set rank_color = '#000000' %}
        {% endif %}
        
        <div class="rank-display {{ display_class }}">
            <span class="rank-label" style="color: {{ rank_color }};">äººç”Ÿãƒ©ãƒ³ã‚¯</span>
            <span class="rank-value" style="color: {{ rank_color }};">{{ rank }}</span>
        </div>
        
        <!-- è¦ªã‚¬ãƒãƒ£ãƒ©ãƒ³ã‚¯ -->
        <div class="parent-rank">
            <span class="parent-rank-label">è¦ªã‚¬ãƒãƒ£ãƒ©ãƒ³ã‚¯</span>
            <span class="parent-rank-value">{{ parent_rank }}</span>
        </div>
        
        <!-- å±•é–‹ãƒœã‚¿ãƒ³ -->
        <button class="expand-btn" onclick="toggleDetails()">
            <span id="expand-icon">â†“</span> è©³ç´°ã‚’å±•é–‹
        </button>
        
        <!-- è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
        <div class="score-section" id="detail-section" style="display: none;">
            <!-- ç·åˆã‚¹ã‚³ã‚¢ -->
            <div class="score-title">{{ total_score }}ç‚¹ã€Œ{{ rank_label }}ã€</div>
            
            <!-- è©³ç´°ãƒ‡ãƒ¼ã‚¿ -->
            <div class="section-title">ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</div>
            <div class="detail-grid">
                <!-- å‡ºç”Ÿæƒ…å ± -->
                <div class="detail-box">
                    <h4>ğŸ‘¶ å‡ºç”Ÿæƒ…å ±</h4>
                    <p><strong>æ€§åˆ¥:</strong> {{ 'ç”·æ€§' if life.get('gender') == 'male' else 'å¥³æ€§' }}</p>
                    <p><strong>å‡ºç”Ÿåœ°:</strong> {{ life.get('birth_city', 'ä¸æ˜') }}</p>
                    <p><strong>ä¸–å¸¯å¹´å:</strong> {{ life.get('household_income', 'ä¸æ˜') }}</p>
                    <p><strong>çˆ¶å­¦æ­´:</strong> {{ format_education(life.get('father_education', 'ä¸æ˜')) }}</p>
                    <p><strong>æ¯å­¦æ­´:</strong> {{ format_education(life.get('mother_education', 'ä¸æ˜')) }}</p>
                </div>
                
                <!-- å­¦æ­´ãƒ»åå·®å€¤ -->
                <div class="detail-box">
                    <h4>ğŸ“š å­¦æ­´ãƒ»åå·®å€¤</h4>
                    {% if life.get('deviation_value') %}
                    <p><strong>å€‹äººåå·®å€¤:</strong> {{ '%.1f'|format(life.get('deviation_value')) }}</p>
                    {% endif %}
                    {% if life.get('high_school') %}
                        {% set hs_deviation = life.get('high_school_deviation', 0) %}
                        {% if hs_deviation %}
                        <p><strong>é«˜æ ¡:</strong> {{ hs_name }} (åå·®å€¤{{ '%.1f'|format(hs_deviation) }})</p>
                        {% else %}
                        <p><strong>é«˜æ ¡:</strong> {{ hs_name or 'é€²å­¦' }}</p>
                        {% endif %}
                    {% else %}
                    <p><strong>é«˜æ ¡:</strong> é€²å­¦ã›ãš</p>
                    {% endif %}
                    {% if life.get('graduation_deviation') and life.get('deviation_value') %}
                        {% set growth = life.get('graduation_deviation') - life.get('deviation_value') %}
                        <p><strong>å’æ¥­æ™‚åå·®å€¤:</strong> {{ '%.1f'|format(life.get('graduation_deviation')) }} ({{ '+%.1f'|format(growth) if growth >= 0 else '%.1f'|format(growth) }})</p>
                    {% endif %}
                    {% if life.get('university') %}
                    <p><strong>å¤§å­¦:</strong> {{ uni_name }}</p>
                    <p><strong>å¤§å­¦ãƒ©ãƒ³ã‚¯:</strong> {{ life.get('university_rank', '') }}</p>
                    {% else %}
                    <p><strong>å¤§å­¦:</strong> é€²å­¦ã›ãš</p>
                    {% endif %}
                </div>
                
                <!-- ã‚­ãƒ£ãƒªã‚¢ -->
                <div class="detail-box">
                    <h4>ğŸ’¼ ã‚­ãƒ£ãƒªã‚¢</h4>
                    <p><strong>ä¼æ¥­è¦æ¨¡:</strong> {{ life.get('company_size', 'ä¸æ˜') }}</p>
                    <p><strong>é›‡ç”¨å½¢æ…‹:</strong> {{ life.get('employment_type', 'ä¸æ˜') }}</p>
                    <p><strong>è»¢è·å›æ•°:</strong> {{ life.get('career_summary', {}).get('total_job_changes', 0) }}å›</p>
                    <p><strong>æ­»äº¡å¹´é½¢:</strong> {{ life.get('death_age', 0) }}æ­³</p>
                    <p><strong>æ­»å› :</strong> {{ life.get('death_cause', 'ä¸æ˜') }}</p>
                </div>
            </div>
            
            <!-- äººç”Ÿã‚¹ã‚³ã‚¢å†…è¨³ -->
            {% set breakdown = score_result.get('breakdown', {}) %}
            <div class="section-title">ğŸ“ˆ äººç”Ÿã‚¹ã‚³ã‚¢å†…è¨³</div>
            <div class="detail-grid">
                <!-- å¯¿å‘½ -->
                {% set lifespan = breakdown.get('lifespan', {}) %}
                <div class="detail-box">
                    <h4>å¯¿å‘½ (40%)</h4>
                    <p><strong>ã‚¹ã‚³ã‚¢:</strong> {{ '%.1f'|format(lifespan.get('score', 0)) }}ç‚¹</p>
                    <p>â†’ {{ lifespan.get('value', '') }}</p>
                </div>
                
                <!-- ç”Ÿæ¶¯å¹´å -->
                {% set income = breakdown.get('lifetime_income', {}) %}
                <div class="detail-box">
                    <h4>ç”Ÿæ¶¯å¹´å (35%)</h4>
                    <p><strong>ã‚¹ã‚³ã‚¢:</strong> {{ '%.1f'|format(income.get('score', 0)) }}ç‚¹</p>
                    <p>â†’ {{ income.get('value', '') }}</p>
                </div>
                
                <!-- å­¦æ­´ -->
                {% set edu = breakdown.get('education', {}) %}
                <div class="detail-box">
                    <h4>å­¦æ­´ (25%)</h4>
                    <p><strong>ã‚¹ã‚³ã‚¢:</strong> {{ '%.1f'|format(edu.get('score', 0)) }}ç‚¹</p>
                    <p>â†’ {{ edu.get('value', '') }}</p>
                </div>
            </div>
            
            <!-- è¦ªã‚¬ãƒãƒ£ã‚¹ã‚³ã‚¢å†…è¨³ -->
            {% set p_breakdown = parent_result.get('breakdown', {}) %}
            {% set parent_total = parent_result.get('total_score', 0)|int %}
            {% set parent_rank_label = parent_result.get('rank_label', '') %}
            <div class="section-title">ğŸ“ˆ è¦ªã‚¬ãƒãƒ£ã‚¹ã‚³ã‚¢å†…è¨³</div>
            <p style="text-align: center; margin-bottom: 16px;"><strong>è¦ªã‚¬ãƒãƒ£: {{ parent_total }}ç‚¹ã€Œ{{ parent_rank_label }}ã€</strong></p>
            <div class="detail-grid">
                <!-- ä¸–å¸¯å¹´å -->
                {% set p_income = p_breakdown.get('household_income', {}) %}
                <div class="detail-box">
                    <h4>ä¸–å¸¯å¹´å (35%)</h4>
                    <p><strong>ã‚¹ã‚³ã‚¢:</strong> {{ '%.1f'|format(p_income.get('score', 0)) }}ç‚¹</p>
                    <p>â†’ {{ p_income.get('value', '') }}</p>
                </div>
                
                <!-- å‡ºç”Ÿåœ° -->
                {% set p_birth = p_breakdown.get('birthplace', {}) %}
                <div class="detail-box">
                    <h4>å‡ºç”Ÿåœ° (35%)</h4>
                    <p><strong>ã‚¹ã‚³ã‚¢:</strong> {{ '%.1f'|format(p_birth.get('score', 0)) }}ç‚¹</p>
                    <p>â†’ {{ p_birth.get('value', '') }}</p>
                </div>
                
                <!-- è¦ªã®å­¦æ­´ -->
                {% set p_edu = p_breakdown.get('parent_education', {}) %}
                <div class="detail-box">
                    <h4>è¦ªã®å­¦æ­´ (30%)</h4>
                    <p><strong>ã‚¹ã‚³ã‚¢:</strong> {{ '%.1f'|format(p_edu.get('score', 0)) }}ç‚¹</p>
                    <p>â†’ {{ p_edu.get('value', '') }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleDetails() {
    const section = document.getElementById('detail-section');
    const icon = document.getElementById('expand-icon');
    const btn = document.querySelector('.expand-btn');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.textContent = 'â†‘';
        btn.innerHTML = '<span id="expand-icon">â†‘</span> é–‰ã˜ã‚‹';
    } else {
        section.style.display = 'none';
        icon.textContent = 'â†“';
        btn.innerHTML = '<span id="expand-icon">â†“</span> è©³ç´°ã‚’å±•é–‹';
    }
}
</script>
{% endblock %}
